{% load a4a %}
{% load crispy_forms_tags %}

<form action="{% url "contrib_global_search" %}#content" method="get" class="card mb-4">
  <div class="card-header">
    <h3 class="h6 mb-0">Rechercher un établissement</h3>
  </div>
  <div class="card-body">
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    {{ form|crispy }}
    <button type="submit" class="btn btn-primary w-100">
      <i aria-hidden="true" class="icon icon-magnifying-glass"></i>
      Rechercher un établissement
    </button>
    <script>
    $(document).ready(function() {
      const codeInseeSelect = $("#id_code_insee");

      codeInseeSelect.select2({
        language: "fr",
        placeholder: "Rechercher une commune",
        theme: "bootstrap4",
        minimumInputLength: 1,
        ajax: {
          cache: true,
          delay: 100,
          url: "https://api-adresse.data.gouv.fr/search/",
          dataType: "json",
          data: function (params) {
            return {
              q: params.term || "",
              type: "municipality",
              autocomplete: 1,
              limit: 5
            };
          },
          processResults: function (results) {
            return {
              results: results.features.map(function(result) {
                return {
                  id: result.properties.citycode,
                  text: result.properties.label + " (" + result.properties.postcode.substr(0, 2) + ")",
                };
              })
            };
          }
        }
      });

      codeInseeSelect.on("select2:select", function(event) {
        try {
          const communeSearch = event.params.data.text;
          $("#id_commune_search").val(communeSearch);
        } catch(err) {
          console.warn("Impossible de récupérer le nom de la commune : " + err);
        }
      });

      // Initialisation et vérification de la présence d'une valeur pré-sélectionnée
      const commune_search = $("#id_commune_search").val();
      const code_insee = "{{ form.code_insee.value }}";
      if (commune_search && code_insee) {
        let option = new Option(commune_search, code_insee, false, false);
        $('#id_code_insee').append(option).trigger("change");
      }
    });
    </script>
  </div>
</form>
