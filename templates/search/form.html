{% load static %}

<form class="a4a-search-form" id="search-form" action="{% url "search" %}">
  <input type="hidden" name="lat">
  <input type="hidden" name="lon">
  <div id="loc-field" class="form-group custom-control custom-switch mb-1 mt-0">
    <input type="checkbox" class="custom-control-input" name="localize" id="localize" value="1"
      {% if localize == "1" %}checked{% endif %}>
    <label class="custom-control-label" for="localize">
      Rechercher autour de ma position géographique actuelle
      <span id="geoloader" class="lds-dual-ring" style="vertical-align:middle"></span>
      <strong id="loc" aria-live="polite" title="Mon emplacement"></strong>
    </label>
  </div>
  <div class="row">
    <div class="where-field col-xl-6 py-1">
      <input type="hidden" id="search_where_label" name="search_where_label" value="{{ search_where_label }}">
      <label for="search_where">
        <strong class="larger-font">Où</strong>
        <span class="text-muted">(ville, département…)</span>
      </label>
      <select id="search_where" name="where" class="select form-control"
        aria-label="Rechercher une commune, un département"></select>
    </div>
    <div class="what-field col-xl-6 py-1">
      <label for="search_what">
        <strong class="larger-font">Quoi</strong>
        <span class="text-muted">(activité, nom de l'établissement…)</span>
      </label>
      <div class="input-group">
        <input type="search" id="search_what" name="what"
          class="form-control" placeholder="Exemple: mairie, café de l'église…"
          aria-label="Rechercher un établissement, une activité" autocomplete="off"
          value="{{ search_what|default_if_none:"" }}">
        <div class="input-group-append">
          <button type="submit" class="btn btn-primary border-left text-nowrap">
            <i aria-hidden="true" class="icon icon-magnifying-glass a4a-icon-small-top"></i>
            <span class="sr-only">Rechercher</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  {% if from_home %}
  <p class="text-center pt-3 mb-0">
    Ou accedez à <a href="{% url "communes" %}">la liste des territoires pilotes</a>.
  </p>
  {% endif %}
</form>

<script>
(function(geolocation) {
  $(document).ready(function() {
    $search_where = $("#search_where");

    $search_where.select2({
      allowClear: true,
      placeholder: "Exemple: 69000, Clichy…",
      theme: "bootstrap4",
      width: "auto",
      ajax: {
        cache: true,
        delay: 100,
        dataType: "json",
        url: "{% url "where" %}"
      }
    });

    // bahaviors on selection
    $search_where.on("select2:select", function(event) {
      if (event.params.data.id === "autour_de_moi") {
        // XXX: run geoloc
        alert("autour de moi");
        $("#search_where_label").val("Autour de moi");
      } else {
        try {
          $("#search_where_label").val(event.params.data.text);
        } catch(err) {
          console.warn("Unable to retrieve where data", err);
        }
      }
    });

    // behaviors when opening the widget
    $search_where.one("select2:open", function(e) {
      $search_field = $("input.select2-search__field");
      // add a placeholder to text input
      $search_field.prop("placeholder", "Tapez le lieu que vous recherchez");
      // add more action links
      const links = [
      '<div class="d-flex justify-content-between pb-1">',
      '  <a class="btn btn-sm btn-link" href="#" onclick="">Autour de moi</a>',
      '  <a class="btn btn-sm btn-link" href="#" onclick="">France entière</a>',
      '</div>'
      ].join("");
      $(links).insertBefore($search_field);
    });

    // initialization and checks for any preexisting value
    const search_where_label = $("#search_where_label").val();
    const search_where_value = "{{ search_where }}";
    if (search_where_label && search_where_value) {
      let option = new Option(search_where_label, search_where_value, false, false);
      $search_where.append(option).trigger("change");
    }
  });

  function renderError(error) {
    document.querySelector("#loc").innerHTML = [
      '<div class="text-danger">',
        '<i aria-hidden="false" class="icon icon-exclamation-circle"></i> ',
        error,
      '</div>',
    ].join("");
  }

  if (!geolocation) {
    renderError("La géolocalisation n'est pas disponible sur votre navigateur.")
    return;
  }

  function listenToLocCheckboxChange() {
    return function(event) {
      processLocCheckbox(event.target, { initial: false });
    }
  }
  function processLocCheckbox(node, options) {
    options = options || { initial: false };
    if (!node.checked) {
      document.querySelector("#loc").innerText = "";
      document.querySelector("input[name=lat]").value = null;
      document.querySelector("input[name=lon]").value = null;
    } else {
      $("#geoloader").show();
      document.querySelector("#loc").innerHTML = "";
      geolocation.getCurrentPosition(function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        fetch("https://api-adresse.data.gouv.fr/reverse/?lon=" + lon + "&lat=" + lat + "&type=street")
          .then(function(response) {
            return response.json()
          })
          .then(function(json) {
            let label;
            try {
              label = "(" + json.features[0].properties.label + ")"
            } catch (e) {
              label = "(" + lat + ", " + lon + ")";
            }
            const loc = document.querySelector("#loc");
            loc.innerText = label;
            loc.setAttribute("role", "status");
            document.querySelector("input[name=lat]").value = lat;
            document.querySelector("input[name=lon]").value = lon;
            $("#geoloader").hide();
            // if ongoing search, submit form with localization data
            if (!options.initial && ($("#search_where").val().trim() || $("#search_what").val().trim())) {
              $("#search-form").submit();
            }
          })
          .catch(function(err) {
            console.warn("Le service de géopositionnement inverse a retourné une erreur : " + err);
            $("#geoloader").hide();
          });
      }, function(err) {
        $("#geoloader").hide();
        document.querySelector("#localize").checked = false;
        renderError("Nous n'avons pas pu déterminer votre position géographique. Erreur: " + err.message)
      }, {
        timeout: 10000
      });
    }
  }
  window.addEventListener("DOMContentLoaded", function() {
    $("#geoloader").hide();
    const locCheckbox = document.querySelector("#localize");
    locCheckbox.addEventListener("change", listenToLocCheckboxChange());
    setTimeout(function() {
      // Note: a timeout is required in order to reprocess the form state after navigating back
      processLocCheckbox(locCheckbox, { initial: true });
    }, 10);
  });
})(navigator.geolocation);
</script>
